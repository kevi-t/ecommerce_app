{% extends "includes/base.html" %}
{% load socialaccount %}

{% block title %}Login - E-Commerce{% endblock %}

{% block content %}
    <h2 class="text-center">Login</h2>
    <p class="text-center">
        Created an account to access products <a href="{% url 'account_signup' %}">Register</a>
    </p>

    <div class="row">
        <div class="col-md-12">
            <form id="loginForm" method="POST">
                {% csrf_token %}
                {{ form.as_p }}
                <input type="hidden" name="next" value="{% url 'home' %}">
                <button type="submit" class="btn btn-primary btn-block">Login</button>
            </form>

            <div class="text-center my-4">
                <span class="text-muted">OR</span>
            </div>

            <div class="text-center">
                <a class="btn btn-danger btn-block" href="{% provider_login_url 'google' %}">
                    <i class="fa-brands fa-google"></i> Sign in with Google
                </a>

                <a class="btn btn-dark btn-block" href="{% provider_login_url 'github' %}">
                    <i class="fa-brands fa-github"></i> Sign in with GitHub
                </a>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("loginForm").onsubmit = function(event) {
            event.preventDefault(); // Prevent form submission
    
            let email = document.getElementsByName("email")[0].value;
            let password = document.getElementsByName("password")[0].value;
            let nextUrl = document.getElementsByName("next")[0].value; // This is for redirecting after successful login
    
            let csrfToken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
    
            fetch("{% url 'account_login' %}", {  // Update this URL to the name of your login URL
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({
                    email: email,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = nextUrl || '/';  // Redirect to the "next" URL or default to homepage
                } else {
                    alert("Invalid login credentials, please try again.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while trying to log in.");
            });
        }
    </script>
    

{% endblock %}